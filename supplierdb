DROP DATABASE supplier;
CREATE DATABASE supplier;
USE supplier;

CREATE TABLE SUPPLIERS (
    SID INT PRIMARY KEY,
    SNAME VARCHAR(100),
    CITY VARCHAR(50)
);

CREATE TABLE PARTS (
    PID INT PRIMARY KEY,
    PNAME VARCHAR(100),
    COLOR VARCHAR(50)
);

CREATE TABLE CATALOG (
    SID INT,
    PID INT,
    COST DECIMAL(10,2),
    PRIMARY KEY (SID, PID),
    FOREIGN KEY (SID) REFERENCES SUPPLIERS(SID),
    FOREIGN KEY (PID) REFERENCES PARTS(PID)
);

insert into SUPPLIERS values
(10001,'acene widget','banglore'),
(10002,'johns','kolkata'),
(10003,'vimal','mumbai'),
(10004,'reliance','delhi');

insert into PARTS values
(20001,'book','red' ),
(20002,'pen','red'),
(20003,'pencil','green'),
(20004,'mobile','green'),
(20005,'charger','black');


insert into CATALOG values
(10001,20001,10),
(10001,20002,10),
(10001,20003,30),
(10001,20004,10),
(10001,20005,10),
(10002,20001,10),
(10002,20002,20),
(10003,20003,30),
(10004,20003,40);



SELECT * FROM SUPPLIERS;
SELECT * FROM PARTS;
SELECT * FROM CATALOG;

SELECT DISTINCT p.PNAME
FROM PARTS p
JOIN CATALOG c ON p.PID = c.PID;

SELECT s.SNAME
FROM SUPPLIERS s
WHERE NOT EXISTS (
    SELECT p.PID
    FROM PARTS p
    WHERE NOT EXISTS (
        SELECT *
        FROM CATALOG c
        WHERE c.SID = s.SID AND c.PID = p.PID
    )
);
   
SELECT s.SNAME
FROM SUPPLIERS s
WHERE NOT EXISTS (
    SELECT p.PID
    FROM PARTS p
    WHERE p.COLOR = 'Red'
    AND NOT EXISTS (
        SELECT *
        FROM CATALOG c
        WHERE c.SID = s.SID AND c.PID = p.PID
    )
);

SELECT p.PNAME
FROM PARTS p
JOIN CATALOG c ON p.PID = c.PID
JOIN SUPPLIERS s ON c.SID = s.SID
WHERE s.SNAME = 'acene widget'
AND p.PID NOT IN (
    SELECT c2.PID
    FROM CATALOG c2
    JOIN SUPPLIERS s2 ON c2.SID = s2.SID
    WHERE s2.SNAME > 'acene widget'
);

SELECT DISTINCT c1.SID
FROM CATALOG c1
WHERE c1.COST > (
    SELECT AVG(c2.COST)
    FROM CATALOG c2
    WHERE c2.PID = c1.PID
);

SELECT p.PID, s.SNAME
FROM PARTS p
JOIN CATALOG c ON p.PID = c.PID
JOIN SUPPLIERS s ON c.SID = s.SID
WHERE c.COST = (
    SELECT MAX(c2.COST)
    FROM CATALOG c2
    WHERE c2.PID = p.PID
);



SELECT P.PID, P.PNAME, C.COST, S.SID, S.SNAME
FROM CATALOG C
JOIN PARTS P ON C.PID = P.PID
JOIN SUPPLIERS S ON C.SID = S.SID
WHERE C.COST = (SELECT MAX(COST) FROM CATALOG);

SELECT *
FROM SUPPLIERS S
WHERE S.SID NOT IN (
    SELECT C.SID
    FROM CATALOG C
    JOIN PARTS P ON C.PID = P.PID
    WHERE P.COLOR = 'red'
);

SELECT S.SID, S.SNAME, SUM(C.COST) AS TOTAL_VALUE
FROM SUPPLIERS S
LEFT JOIN CATALOG C ON S.SID = C.SID
GROUP BY S.SID, S.SNAME;

SELECT S.SID, S.SNAME
FROM SUPPLIERS S
JOIN CATALOG C ON S.SID = C.SID
WHERE C.COST < 20
GROUP BY S.SID, S.SNAME
HAVING COUNT(*) >= 2;

SELECT C.SID, S.SNAME, C.PID, P.PNAME, C.COST
FROM CATALOG C
JOIN SUPPLIERS S ON C.SID = S.SID
JOIN PARTS P ON C.PID = P.PID
WHERE (C.PID, C.COST) IN (
    SELECT PID, MIN(COST)
    FROM CATALOG
    GROUP BY PID
);

CREATE VIEW supplier_part_count AS
SELECT S.SID, S.SNAME, COUNT(C.PID) AS TOTAL_PARTS
FROM SUPPLIERS S
LEFT JOIN CATALOG C ON S.SID = C.SID
GROUP BY S.SID, S.SNAME;

CREATE VIEW most_expensive_supplier_per_part AS
SELECT C.SID, S.SNAME, C.PID, P.PNAME, C.COST
FROM CATALOG C
JOIN SUPPLIERS S ON C.SID = S.SID
JOIN PARTS P ON C.PID = P.PID
WHERE (C.PID, C.COST) IN (
    SELECT PID, MAX(COST)
    FROM CATALOG
    GROUP BY PID
);
